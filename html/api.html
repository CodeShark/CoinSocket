<html>
<head>
<title>CoinSocket API</title>
<link rel="stylesheet" type="text/css" href="css/tables.css" />
<style>
.command {
    padding:6px;
    color: black;
    background-color: white;
    border: black 2px solid;
}
#output {
    width: 100%;
    height: 90%;
}
</style>
</head>
<body>
<p><span>CoinSocket API</span></p>
<div>
    Server: <input type="text" id="url" value="ws://test.ciphrex.com:8080" size="50" />
    <input type="button" id="connectbutton" onclick="connect()" value="Connect" />
</div>
<div style="width: 100%; overflow: hidden;">
    <div style="float: left; width: 35%; height: 100%; overflow: scroll;">
        <h3>Commands</h3>
        <div>
            <h4>Global Operations</h4>
            <div class="command">
                <p>getvaultinfo</p>
                <table class="gridtable">
                    <tr><td></td><td></td>
                        <td>
                            <input type="button" onclick="getvaultinfo()" value="Submit" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div>
            <h4>Keychain Operations</h4>
            <div class="command">
                <p>newkeychain</p>
                <table class="gridtable">
                    <tr><td>string</td><td>name</td>
                        <td>
                            <input type="text" id="newkeychain_name" />
                        </td>
                    </tr>
                    <tr><td></td><td></td>
                        <td>
                            <input type="button" onclick="newkeychain()" value="Submit" />
                        </td>
                    </tr>
                </table>
            </div>
            <div class="command">
                <p>renamekeychain</p>
                <table class="gridtable">
                    <tr><td>string</td><td>oldname</td>
                        <td>
                            <input type="text" id="renamekeychain_oldname" />
                        </td>
                    </tr>
                    <tr><td>string</td><td>newname</td>
                        <td>
                            <input type="text" id="renamekeychain_newname" />
                        </td>
                    </tr>
                    <tr><td></td><td></td>
                        <td>
                            <input type="button" onclick="renamekeychain()" value="Submit" />
                        </td>
                    </tr>
                </table>
            </div>
            <div class="command">
                <p>getkeychaininfo</p>
                <table class="gridtable">
                    <tr><td>string</td><td>name</td>
                        <td>
                            <input type="text" id="getkeychaininfo_name" />
                        </td>
                    </tr>
                    <tr><td></td><td></td>
                        <td>
                            <input type="button" onclick="getkeychaininfo()" value="Submit" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div>
            <h4>Blockchain Operations</h4>
            <div class="command">
                <p>getblockheader</p>
                <table class="gridtable">
                    <tr><td>integer</td><td>height</td>
                        <td>
                            <input type="text" id="getblockheader_int_height" />
                        </td>
                    </tr>
                    <tr><td></td><td></td>
                        <td>
                            <input type="button" onclick="getblockheader_int()" value="Submit" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div style="float: left; width: 60%; height: 100%; overflow: scroll;">
        <h3>Output</h3>
        <div>
            <textarea id="output"></textarea>
        </div>
        <div>
            <input type="checkbox" id="autoscroll" checked />Autoscroll
        </div>
        <div>
            <tt><span id="statusbar"></span></tt>
        </div>
        <div id="uridiv">
        </div>
    </div>
</div>
<script type="text/javascript">
    var connectbutton; // = document.getElementById('connectbutton');
    var output; // = document.getElementById('output');
    var autoscroll; // = document.getElementById('autoscroll');
    var statusbar; // = document.getElementById('statusbar');
 
    var urlinput; // = document.getElementById('url');
    var serverurl;
 
    var uridiv;
 
    var ws = null;

    var requestid = 0;
 
    var onopen = function () {
        setstatus('Connected to ' + serverurl + '.');
        appendoutput('CONNECTED TO ' + serverurl + '.');
        connectbutton.value = 'Disconnect';
    };
 
    var onclose = function () {
        ws = null;
        setstatus('Connection closed.');
        appendoutput('DISCONNECTED FROM ' + serverurl + '.');
        connectbutton.value = 'Connect';
    };

    var onmessage = function (e) {
        console.log(e.data);
        var obj = JSON.parse(e.data);
        var json = JSON.stringify(obj, undefined, 2);
        output.value += json + '\n\n';
        if (autoscroll.checked)
            output.scrollTop = output.scrollHeight;
 
        // update uri
        if (obj.hasOwnProperty('result') && obj.result.hasOwnProperty('uri')) {
            uridiv.innerHTML = '<a href="' + obj.result.uri + '">Request from local wallet...</a>';
        }
        else {
            uridiv.innerHTML = '';
        }
    };
 
    function connect() {
        if (ws) {
//            document.getElementById('sendbutton').disabled = true;
            ws.close();
            return;
        }
 
        serverurl = urlinput.value;
        setstatus('Connecting to ' + serverurl + '...');
 
        ws = new WebSocket(serverurl);
        ws.onopen = onopen;
        ws.onclose = onclose;
        ws.onmessage = onmessage;
 
//        document.getElementById('sendbutton').disabled = false;
    }

    function sendrequest(req) {
        if (!ws) return;

        appendoutput('Sending ' + req  + ' ...');
        if (autoscroll.checked)
            output.scrollTop = output.scrollHeight;

        ws.send(req);
    }

    function appendoutput(o) {
        output.value += o + '\n\n';
    }

    function setstatus(s) {
        statusbar.innerHTML = s;
    }

    window.onload = function () {
        connectbutton = document.getElementById('connectbutton');
        output = document.getElementById('output');
        autoscroll = document.getElementById('autoscroll');
        statusbar = document.getElementById('statusbar');
        urlinput = document.getElementById('url');
        uridiv = document.getElementById('uridiv');
    };

    // COMMANDS

    // Global Operations
    function getvaultinfo() {
        if (!ws) return;
        var req = '{"method": "getvaultinfo", "id": ' + requestid + '}';
        requestid++;
        sendrequest(req);
    }

    // Keychain Operations
    function newkeychain() {
        if (!ws) return;
        var keychainname = document.getElementById('newkeychain_name').value;
        var req = '{"method": "newkeychain", "params":["' + keychainname + '"], "id": ' + requestid + '}';
        requestid++;
        sendrequest(req);
    }

    function renamekeychain() {
        if (!ws) return;
        var oldname = document.getElementById('renamekeychain_oldname').value;
        var newname = document.getElementById('renamekeychain_newname').value;
        var req = '{"method": "renamekeychain", "params":["' + oldname + '", "' + newname + '"], "id": ' + requestid + '}';
        requestid++;
        sendrequest(req);
    }

    function getkeychaininfo() {
        if (!ws) return;
        var keychainname = document.getElementById('getkeychaininfo_name').value;
        var req = '{"method": "getkeychaininfo", "params":["' + keychainname + '"], "id": ' + requestid + '}';
        requestid++;
        sendrequest(req);
    }

    // Blockchain Operations
    function getblockheader_int() {
        if (!ws) return;
        var height = document.getElementById('getblockheader_int_height').value;
        var req = '{"method": "getblockheader", "params":[' + height + '], "id": ' + requestid + '}';
        requestid++;
        sendrequest(req);
    }
</script>
</body>
</html>
